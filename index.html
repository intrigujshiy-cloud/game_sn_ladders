<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Planet Game: Super Editor No-Memory</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Comfortaa:wght@700&family=Bungee&family=Kelly+Slab&family=Monoton&family=Pacifico&family=Ruslan+Display&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #1a1a1a; }
        canvas { display: block; }
        #panel {
            position: absolute; left: 10px; top: 10px; width: 340px; 
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 10px;
            z-index: 100; color: white; border: 1px solid #444;
            max-height: 95vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #turn-indicator {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: rgba(0,0,0,0.8); color: gold;
            border: 2px solid gold; border-radius: 20px;
            font-weight: bold;
            z-index: 50; display: none; font-size: 18px;
        }
        .input-wrap { position: relative; display: flex; align-items: center; margin-bottom: 8px; }
        .clear-btn { 
            position: absolute; right: 5px; background: none; border: none; 
            color: #888; cursor: pointer; font-size: 18px; font-weight: bold; 
            padding: 0 5px; line-height: 1; z-index: 5;
        }
        .clear-btn:hover { color: #f44336; }
        .tasks-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .tasks-row div { flex: 1; }
        .tasks-row textarea { height: 80px; resize: none; }
        .colors-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .colors-grid label { font-size: 10px; display: flex; flex-direction: column; }
        input, textarea, select { width: 100%; background: #222; color: white; border: 1px solid #555; padding: 5px 25px 5px 5px; box-sizing: border-box; border-radius: 4px; }
        .neon-row { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .size-settings { margin-bottom: 15px; }
        .half-width-sliders { display: flex; gap: 10px; }
        .half-width-sliders div { flex: 1; }
        .size-label { font-size: 11px; margin-bottom: 4px; display: block; }
        #font-preview { background: #444; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 10px; font-size: 18px; border: 1px solid #666; min-height: 25px; }

        /* –≠–ö–†–ê–ù –ü–û–ë–ï–î–´ */
        #victory-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 20000;
            flex-direction: column; justify-content: center; align-items: center; text-align: center; 
        }
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .cup { font-size: 150px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .retry-btn { 
            margin-top: 30px; padding: 15px 40px; font-size: 24px; cursor: pointer; 
            background: #4CAF50; color: white; border: none; border-radius: 50px; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="turn-indicator">–•–û–î –ò–ì–†–û–ö–ê: 1</div>

<div id="panel">
    <h3 style="margin:0 0 10px 0; color: #4CAF50;">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (3D Planet)</h3>
    <div class="input-wrap">
        <input type="text" id="sheet-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ Google –¢–∞–±–ª–∏—Ü—É (CSV)" oninput="loadFromSheet(this.value)">
        <button class="clear-btn" onclick="clearInp('sheet-url')">√ó</button>
    </div>
    <div class="input-wrap"><input type="text" id="bg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –ò–ì–†–´" oninput="update()"><button class="clear-btn" onclick="clearInp('bg-url')">√ó</button></div>
    <div class="input-wrap"><input type="text" id="modal-bg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –û–ö–ù–ê (URL)" oninput="update()"><button class="clear-btn" onclick="clearInp('modal-bg-url')">√ó</button></div>
    <div class="input-wrap"><input type="text" id="music-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ú–£–ó–´–ö–£ (MP3)" oninput="update()"><button class="clear-btn" onclick="clearInp('music-url')">√ó</button></div>
    
    <label style="font-size:11px">–®–†–ò–§–¢ –ò–ì–†–´:</label>
    <select id="game-font" onchange="update()" style="margin-bottom: 8px;">
        <option value="Arial">–°—Ç–∞–Ω–¥–∞—Ä—Ç (Arial)</option>
        <option value="'Comfortaa', sans-serif">–ú—è–≥–∫–∏–π (Comfortaa)</option>
        <option value="'Press Start 2P', cursive">–ü–∏–∫—Å–µ–ª—å–Ω—ã–π (8-bit)</option>
        <option value="'Bungee', cursive">–ñ–∏—Ä–Ω—ã–π (Bungee)</option>
        <option value="'Kelly Slab', cursive">–¢–µ—Ö–Ω–æ (Kelly Slab)</option>
        <option value="'Monoton', cursive">–†–µ—Ç—Ä–æ-–ù–µ–æ–Ω (Monoton)</option>
        <option value="'Pacifico', cursive">–†—É–∫–æ–ø–∏—Å–Ω—ã–π (Pacifico)</option>
        <option value="'Ruslan Display', cursive">–°–ª–∞–≤—è–Ω—Å–∫–∏–π (Ruslan)</option>
    </select>
    <div id="font-preview">–¢–ï–ö–°–¢ –¢–ï–ö–°–¢ 123</div>

    <div class="neon-row">
        <label style="font-size:12px; font-weight:bold;">–ö–û–õ-–í–û –ò–ì–†–û–ö–û–í:</label>
        <select id="p-count" onchange="update()" style="width:60px; margin:0;">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
        </select>
    </div>

    <div class="size-settings" style="background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
        <div class="half-width-sliders">
            <div>
                <label class="size-label">–®–∏—Ä–∏–Ω–∞ —Ñ–∏—à–∫–∏: <span id="tw-val">50</span>px</label>
                <input type="range" id="token-w" min="10" max="200" value="50" oninput="update()">
            </div>
            <div>
                <label class="size-label">–í—ã—Å–æ—Ç–∞ —Ñ–∏—à–∫–∏: <span id="th-val">50</span>px</label>
                <input type="range" id="token-h" min="10" max="200" value="50" oninput="update()">
            </div>
        </div>
    </div>

    <div class="colors-grid">
        <label>–•–í–û–°–¢ –§–ò–®–ö–ò: 
            <select id="trail-type" onchange="update()">
                <option value="match">–í —Ü–≤–µ—Ç</option>
                <option value="rainbow">–†–ê–î–£–ì–ê</option>
                <option value="custom">–°–≤–æ–π —Ü–≤–µ—Ç</option>
                <option value="none">–ù–µ—Ç</option>
            </select>
        </label>
        <label>–¶–í–ï–¢ –•–í–û–°–¢–ê <input type="color" id="c-trail" value="#ffffff" oninput="update()" style="height:25px;"></label>
    </div>

    <label style="font-size:11px">–°–ö–ò–ù –ö–£–ë–ò–ö–ê:</label>
    <select id="dice-skin" onchange="update()" style="margin-bottom: 8px;">
        <option value="classic">–ö–ª–∞—Å—Å–∏–∫–∞ (–ë–µ–ª—ã–π)</option>
        <option value="glass">–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π</option>
        <option value="neon">–ù–µ–æ–Ω–æ–≤—ã–π</option>
        <option value="gold">–ó–æ–ª–æ—Ç–æ–π</option>
    </select>

    <div class="colors-grid">
        <div class="input-wrap"><input type="text" id="t1" placeholder="–§–∏—à–∫–∞ 1" oninput="update()"><button class="clear-btn" onclick="clearInp('t1')">√ó</button></div>
        <div class="input-wrap"><input type="text" id="t2" placeholder="–§–∏—à–∫–∞ 2" oninput="update()"><button class="clear-btn" onclick="clearInp('t2')">√ó</button></div>
        <div class="input-wrap"><input type="text" id="t3" placeholder="–§–∏—à–∫–∞ 3" oninput="update()"><button class="clear-btn" onclick="clearInp('t3')">√ó</button></div>
        <div class="input-wrap"><input type="text" id="t4" placeholder="–§–∏—à–∫–∞ 4" oninput="update()"><button class="clear-btn" onclick="clearInp('t4')">√ó</button></div>
    </div>

    <div class="input-wrap"><input type="text" id="ladder-url" placeholder="URL –õ–µ—Å—Ç–Ω–∏—Ü—ã" oninput="update()"><button class="clear-btn" onclick="clearInp('ladder-url')">√ó</button></div>
    <div class="input-wrap"><input type="text" id="snake-url" placeholder="URL –ó–º–µ–∏" oninput="update()"><button class="clear-btn" onclick="clearInp('snake-url')">√ó</button></div>

    <div class="tasks-row">
        <div><label style="font-size:10px">–í–û–ü–†–û–°–´</label><textarea id="qs" oninput="update()"></textarea></div>
        <div><label style="font-size:10px">–û–¢–í–ï–¢–´</label><textarea id="ans" oninput="update()"></textarea></div>
    </div>

    <div class="size-settings">
        <label class="size-label">–ö–ª–µ—Ç–∫–∏: <span id="sz-val">60</span>px</label>
        <input type="range" id="cell-size" min="30" max="150" value="60" oninput="update()">
        <div class="half-width-sliders">
            <div>
                <label class="size-label">–õ–µ—Å—Ç–Ω–∏—Ü—ã: <span id="l-th-val">60</span>px</label>
                <input type="range" id="ladder-th" min="10" max="250" value="60" oninput="update()">
            </div>
            <div>
                <label class="size-label">–ó–º–µ–∏: <span id="s-th-val">60</span>px</label>
                <input type="range" id="snake-th" min="10" max="250" value="60" oninput="update()">
            </div>
        </div>
    </div>

    <select id="cell-shape" onchange="update()" style="margin-bottom: 8px;">
        <option value="circle">–ö—Ä—É–≥ (–•—Ä—É—Å—Ç–∞–ª—å)</option>
        <option value="square">–ö–≤–∞–¥—Ä–∞—Ç (–•—Ä—É—Å—Ç–∞–ª—å)</option>
        <option value="rect">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (–•—Ä—É—Å—Ç–∞–ª—å)</option>
    </select>

    <div class="neon-row">
        <label style="font-size:12px; font-weight:bold;">NEON EFFECT</label>
        <input type="checkbox" id="neon-on" onchange="update()" checked style="width:20px;">
    </div>

    <div class="colors-grid">
        <label>–ö—Ä—É–∂–∫–∏ <input type="color" id="c-dots" value="#ffffff" oninput="update()" style="height:25px;"></label>
        <label>–¶–≤–µ—Ç –æ–∫–Ω–∞ <input type="color" id="c-bg" value="#fff9e6" oninput="update()" style="height:25px;"></label>
        <label>–¢–µ–∫—Å—Ç –æ–∫–Ω–∞ <input type="color" id="c-txt" value="#333333" oninput="update()" style="height:25px;"></label>
        <label>–ö–Ω–æ–ø–∫–∞ <input type="color" id="c-btn" value="#4CAF50" oninput="update()" style="height:25px;"></label>
    </div>

    <button id="link-btn" class="btn" style="background:#9c27b0" onclick="toggleLinkMode()">–°–≤—è–∑–∞—Ç—å –∫—Ä—É–∂–∫–∏</button>
    <button class="btn" style="background:#ff9800" onclick="state.points.pop(); draw(); update();">–û—Ç–º–µ–Ω–∞ —à–∞–≥–∞</button>
    <button class="btn" style="background:#2196F3" onclick="save()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <button class="btn" style="background:#673ab7" onclick="getIframe()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ iFrame</button>
    <button class="btn" style="background:#f44336" onclick="clearFieldOnly()">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
</div>

<div id="victory-overlay">
    <canvas id="confetti-canvas"></canvas>
    <h1 id="vic-title" style="font-size: 80px; margin: 0; color: gold;">–ü–û–ë–ï–î–ê!</h1>
    <div class="cup">üèÜ</div>
    <button class="retry-btn" onclick="location.reload()">–ò–ì–†–ê–¢–¨ –ó–ê–ù–û–í–û</button>
</div>

<canvas id="cvs"></canvas>

<script>
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const cnfCvs = document.getElementById('confetti-canvas');
    const cnfCtx = cnfCvs.getContext('2d');
    
    let audioCtx = null;
    const bgMusic = new Audio(); bgMusic.loop = true;

    let state = { 
        bg: '', modalBgImg: '', music: '', tokens: ['', '', '', ''], ladderImg: '', snakeImg: '', points: [], 
        cellSize: 60, ladderTh: 60, snakeTh: 60, tokenW: 50, tokenH: 50, tasks: [], playerCount: 4,
        colors: { dots: '#ffffff', modalBg: '#fff9e6', modalTxt: '#333333', btnBg: '#4CAF50', trail: '#ffffff' }, 
        neon: true, cellShape: 'circle', font: 'Arial', diceSkin: 'classic',
        trailType: 'match', links: [],
        startPos: {x: 0.1, y: 0.1}, finishPos: {x: 0.9, y: 0.1} // –ù–æ–≤—ã–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –Ω–∞–¥–ø–∏—Å–∏
    };
    
    const bgImg = new Image();
    const tImgs = [new Image(), new Image(), new Image(), new Image()];
    const ladderImgObj = new Image();
    const snakeImgObj = new Image();
    let tPos = [
        {x:window.innerWidth-150,y:50,tx:window.innerWidth-150,ty:50}, 
        {x:window.innerWidth-80,y:50,tx:window.innerWidth-80,ty:50}, 
        {x:window.innerWidth-150,y:120,tx:window.innerWidth-150,ty:120}, 
        {x:window.innerWidth-80,y:120,tx:window.innerWidth-80,ty:120}
    ];
    let dragIdx = null, dragType = null, isGame = false, diceVal = "?", isRoll = false, won = false;
    let linkFrom = null, isLinkMode = false, particles = [], trailParticles = [];
    let pulseFrame = 0, hue = 0, currentPlayer = 0;

    function playSfx(freq) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function encode(o) { return btoa(unescape(encodeURIComponent(JSON.stringify(o)))); }
    function decode(s) { return JSON.parse(decodeURIComponent(escape(atob(s)))); }

    window.onload = () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        resize();
        const p = new URLSearchParams(window.location.search);
        const d = p.get('game');
        if (d) {
            try {
                state = decode(d);
                isGame = true;
                document.getElementById('panel').style.display = 'none';
                document.getElementById('turn-indicator').style.display = 'block';
            } catch(e) { console.error(e); }
        }
        update();
        animate();
    };

    function animate() {
        pulseFrame += 0.035; hue = (hue + 2) % 360;
        tPos.forEach(p => { p.x += (p.tx - p.x) * 0.2; p.y += (p.ty - p.y) * 0.2; });
        draw();
        if (won) {
            cnfCtx.clearRect(0, 0, cnfCvs.width, cnfCvs.height);
            if(particles.length < 80) {
                for(let i=0; i<5; i++) particles.push({x:cnfCvs.width/2, y:cnfCvs.height/2, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15-5, gravity:0.2, color:`hsl(${Math.random()*360},100%,50%)`, size:Math.random()*10+5});
            }
            particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.vy += p.gravity; cnfCtx.fillStyle=p.color; cnfCtx.beginPath(); cnfCtx.arc(p.x,p.y,p.size,0,Math.PI*2); cnfCtx.fill(); if(p.y > cnfCvs.height) particles.splice(i,1); });
        }
        requestAnimationFrame(animate);
    }

    function draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        if (bgImg.src) ctx.drawImage(bgImg, 0, 0, cvs.width, cvs.height);

        // –ù–ï–ó–ê–í–ò–°–ò–ú–´–ï –ù–ê–î–ü–ò–°–ò
        ctx.font = `bold ${state.cellSize * 0.7}px ${state.font}`;
        ctx.textAlign = "center";
        ctx.fillStyle = state.colors.dots;
        if(state.neon) { ctx.shadowBlur = 10; ctx.shadowColor = state.colors.dots; }
        ctx.fillText("START", state.startPos.x * cvs.width, state.startPos.y * cvs.height);
        ctx.fillText("FINISH", state.finishPos.x * cvs.width, state.finishPos.y * cvs.height);
        ctx.shadowBlur = 0;

        state.links.forEach(l => {
            const p1 = state.points[l.from], p2 = state.points[l.to];
            const isL = p1.y > p2.y; const img = isL ? ladderImgObj : snakeImgObj;
            const th = isL ? state.ladderTh : state.snakeTh;
            if (img.src) {
                ctx.save();
                const dx = (p2.x - p1.x) * cvs.width, dy = (p2.y - p1.y) * cvs.height;
                const dist = Math.hypot(dx, dy), ang = Math.atan2(dy, dx);
                ctx.translate(p1.x * cvs.width, p1.y * cvs.height); ctx.rotate(ang);
                ctx.drawImage(img, 0, -th / 2, dist, th); ctx.restore();
            }
        });

        state.points.forEach((p, i) => {
            ctx.save(); ctx.translate(p.x * cvs.width, p.y * cvs.height);
            if (state.neon) { ctx.shadowBlur = 15; ctx.shadowColor = state.colors.dots; }
            ctx.fillStyle = state.colors.dots; ctx.beginPath();
            const s = state.cellSize / 2;
            if (state.cellShape === 'circle') ctx.arc(0, 0, s, 0, Math.PI * 2);
            else if (state.cellShape === 'square') ctx.rect(-s, -s, s * 2, s * 2);
            else ctx.rect(-s, -s / 1.5, s * 2, s * 2 / 1.5);
            ctx.fill(); ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.font = "bold 14px Arial"; ctx.fillText(i + 1, 0, 5); ctx.restore();
        });

        tPos.slice(0, state.playerCount).forEach((p, i) => {
            if (tImgs[i].src) ctx.drawImage(tImgs[i], p.x - state.tokenW / 2, p.y - state.tokenH / 2, state.tokenW, state.tokenH);
            else { ctx.fillStyle = ['#ff4d4d', '#4d4dff', '#4dff4d', '#ffff4d'][i]; ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI * 2); ctx.fill(); }
        });

        if (isGame) {
            const x = 50, y = cvs.height - 150, sz = 100;
            ctx.fillStyle = (state.diceSkin === 'neon') ? '#000' : 'white';
            ctx.beginPath(); ctx.roundRect(x, y, sz, sz, 15); ctx.fill();
            ctx.fillStyle = (state.diceSkin === 'neon') ? '#0ff' : '#333';
            ctx.font = "bold 50px Arial"; ctx.textAlign = "center"; ctx.fillText(diceVal, x + 50, y + 65);
        }
    }

    function rollDice() {
        if (isRoll || won) return;
        isRoll = true; let rolls = 0;
        const iv = setInterval(() => {
            diceVal = Math.floor(Math.random() * 6) + 1; rolls++;
            if (rolls > 10) {
                clearInterval(iv); isRoll = false;
                const p = tPos[currentPlayer];
                let currentIdx = state.points.findIndex(pt => Math.hypot(p.tx - pt.x * cvs.width, p.ty - pt.y * cvs.height) < 10);
                let nextIdx = currentIdx + diceVal;
                if (nextIdx >= state.points.length - 1) nextIdx = state.points.length - 1;
                p.tx = state.points[nextIdx].x * cvs.width; p.ty = state.points[nextIdx].y * cvs.height;
                
                if (nextIdx === state.points.length - 1) {
                    setTimeout(() => { won = true; document.getElementById('victory-overlay').style.display = 'flex'; }, 800);
                }
                currentPlayer = (currentPlayer + 1) % state.playerCount;
                document.getElementById('turn-indicator').innerText = `–•–û–î –ò–ì–†–û–ö–ê: ${currentPlayer + 1}`;
            }
        }, 80);
    }

    cvs.onmousedown = (e) => {
        if (won) return;
        const x = e.clientX / cvs.width, y = e.clientY / cvs.height;
        if (isGame) {
            if (e.clientX > 40 && e.clientX < 160 && e.clientY > cvs.height - 160 && e.clientY < cvs.height - 40) rollDice();
            return;
        }

        if (Math.hypot(state.startPos.x - x, state.startPos.y - y) < 0.05) { dragType = 'start'; return; }
        if (Math.hypot(state.finishPos.x - x, state.finishPos.y - y) < 0.05) { dragType = 'finish'; return; }

        if (isLinkMode) {
            const idx = state.points.findIndex(p => Math.hypot(p.x - x, p.y - y) < 0.05);
            if (idx !== -1) {
                if (linkFrom === null) linkFrom = idx;
                else { if (linkFrom !== idx) state.links.push({ from: linkFrom, to: idx }); linkFrom = null; }
            }
        } else {
            const idx = state.points.findIndex(p => Math.hypot(p.x - x, p.y - y) < 0.03);
            if (idx !== -1) { dragIdx = idx; dragType = 'point'; } else state.points.push({ x, y });
        }
        update();
    };

    cvs.onmousemove = (e) => {
        const x = e.clientX / cvs.width, y = e.clientY / cvs.height;
        if (dragType === 'point' && dragIdx !== null) { state.points[dragIdx].x = x; state.points[dragIdx].y = y; }
        if (dragType === 'start') { state.startPos.x = x; state.startPos.y = y; }
        if (dragType === 'finish') { state.finishPos.x = x; state.finishPos.y = y; }
    };

    cvs.onmouseup = () => {
        if (dragType === 'point' && typeof dragIdx === 'number') {
            const idx = dragIdx;
            state.points.forEach((p, pIdx) => { if (Math.hypot(tPos[idx].tx-p.x*cvs.width, tPos[idx].ty-p.y*cvs.height) < 50) { tPos[idx].tx = p.x*cvs.width; tPos[idx].ty = p.y*cvs.height; const link = state.links.find(l => l.from === pIdx); if (link) { setTimeout(() => { tPos[idx].tx = state.points[link.to].x*cvs.width; tPos[idx].ty = state.points[link.to].y*cvs.height; }, 500); } } });
        }
        dragIdx = null; dragType = null; update();
    };

    function update() {
        state.bg = document.getElementById('bg-url').value;
        state.tokens = [document.getElementById('t1').value, document.getElementById('t2').value, document.getElementById('t3').value, document.getElementById('t4').value];
        state.ladderImg = document.getElementById('ladder-url').value;
        state.snakeImg = document.getElementById('snake-url').value;
        state.cellSize = parseInt(document.getElementById('cell-size').value);
        state.playerCount = parseInt(document.getElementById('p-count').value);
        state.font = document.getElementById('game-font').value;
        state.cellShape = document.getElementById('cell-shape').value;
        state.colors.dots = document.getElementById('c-dots').value;
        state.diceSkin = document.getElementById('dice-skin').value;
        state.neon = document.getElementById('neon-on').checked;
        
        if (state.bg) bgImg.src = state.bg;
        if (state.ladderImg) ladderImgObj.src = state.ladderImg;
        if (state.snakeImg) snakeImgObj.src = state.snakeImg;
        state.tokens.forEach((url, i) => { if(url) tImgs[i].src = url; });

        document.getElementById('tw-val').innerText = document.getElementById('token-w').value;
        document.getElementById('th-val').innerText = document.getElementById('token-h').value;
        document.getElementById('sz-val').innerText = state.cellSize;
    }

    function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; cnfCvs.width = window.innerWidth; cnfCvs.height = window.innerHeight; }
    function toggleLinkMode() { isLinkMode = !isLinkMode; linkFrom = null; }
    function clearFieldOnly() { state.points = []; state.links = []; update(); }
    function clearInp(id) { document.getElementById(id).value = ''; update(); }
    function save() { update(); const s = JSON.parse(JSON.stringify(state)); s.tasks = []; const url = window.location.origin + window.location.pathname + "?game=" + encode(s); navigator.clipboard.writeText(url); alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"); }
    function getIframe() { const url = window.location.origin + window.location.pathname + "?game=" + encode(state); const code = `<iframe src="${url}" width="100%" height="600px" frameborder="0"></iframe>`; navigator.clipboard.writeText(code); alert("–ö–æ–¥ iFrame —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!"); }

    // –¢–í–û–ô –ö–û–î –ó–ê–ì–†–£–ó–ö–ò –ò–ó –¢–ê–ë–õ–ò–¶ (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
    async function loadFromSheet(url) {
        if (!url.includes('docs.google.com')) return;
        const id = url.split('/d/')[1].split('/')[0];
        const csvUrl = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;
        try {
            const resp = await fetch(csvUrl); const txt = await resp.text();
            const rows = txt.split('\n').map(r => r.split(','));
            state.tasks = rows.map(r => ({ q: r[0]?.trim(), a: r[1]?.trim() })).filter(t => t.q);
            document.getElementById('qs').value = state.tasks.map(t => t.q).join('\n');
            document.getElementById('ans').value = state.tasks.map(t => t.a).join('\n');
        } catch(e) { console.error("–û—à–∏–±–∫–∞ —Ç–∞–±–ª–∏—Ü—ã:", e); }
    }
</script>
</body>
</html>
