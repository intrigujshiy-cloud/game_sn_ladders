<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Planet Game: Crystal Rainbow Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Comfortaa:wght@700&family=Bungee&family=Kelly+Slab&family=Monoton&family=Pacifico&family=Ruslan+Display&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #1a1a1a; width: 100vw; height: 100vh; position: fixed; }
        canvas { display: block; touch-action: none; width: 100%; height: 100%; }
        #panel {
            position: absolute; left: 10px; top: 10px; width: 340px; 
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 10px;
            z-index: 100; color: white; border: 1px solid #444;
            max-height: 95vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #turn-indicator {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: rgba(0,0,0,0.8); color: gold;
            border: 2px solid gold; border-radius: 20px; font-weight: bold;
            z-index: 50; display: none; font-size: 18px;
        }
        .input-wrap { position: relative; display: flex; align-items: center; margin-bottom: 8px; }
        .clear-btn { 
            position: absolute; right: 5px; background: none; border: none; 
            color: #888; cursor: pointer; font-size: 18px; font-weight: bold; 
            padding: 0 5px; line-height: 1; z-index: 5;
        }
        .clear-btn:hover { color: #f44336; }
        input, textarea, select { width: 100%; background: #222; color: white; border: 1px solid #555; padding: 5px 25px 5px 5px; box-sizing: border-box; border-radius: 4px; }
        .btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        #task-modal { 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 400px; min-height: 200px; padding: 30px; border-radius: 20px; 
            z-index: 10000; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            border: 2px solid #f0e68c; background-size: cover; background-color: white;
        }
        #task-modal.show { display: block; }
        #answer-input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 16px; border: 1px solid #ccc; color: #333; }
        #check-btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; color: white; }
        #victory-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, #ff9999, #99ff99, #99ccff); z-index: 20000; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

<div id="turn-indicator">–•–û–î –ò–ì–†–û–ö–ê: 1</div>

<div id="panel">
    <h3 style="margin:0 0 10px 0; color: #4CAF50;">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (Rainbow Crystal)</h3>
    <input type="text" id="sheet-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ Google –¢–∞–±–ª–∏—Ü—É (CSV)" oninput="loadFromSheet(this.value)">
    <input type="text" id="bg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –ò–ì–†–´" oninput="update()">
    <input type="text" id="modal-bg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –û–ö–ù–ê (URL)" oninput="update()">
    <input type="text" id="music-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ú–£–ó–´–ö–£ (MP3)" oninput="update()">
    
    <label>–®–†–ò–§–¢:</label>
    <select id="game-font" onchange="update()">
        <option value="Arial">Arial</option>
        <option value="'Comfortaa', sans-serif">Comfortaa</option>
        <option value="'Press Start 2P', cursive">Pixel</option>
        <option value="'Kelly Slab', cursive">Kelly Slab</option>
    </select>

    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
        <label>–ò–ì–†–û–ö–û–í:</label>
        <select id="p-count" onchange="update()" style="width:60px;">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
        </select>
    </div>

    <label>–ö–ª–µ—Ç–∫–∏: <span id="sz-val">60</span>px</label>
    <input type="range" id="cell-size" min="30" max="150" value="60" oninput="update()">
    
    <label>–§–∏—à–∫–∏: <span id="tw-val">50</span>px</label>
    <input type="range" id="token-w" min="10" max="150" value="50" oninput="update()">

    <select id="cell-shape" onchange="update()">
        <option value="circle">–ö—Ä—É–≥ (–•—Ä—É—Å—Ç–∞–ª—å)</option>
        <option value="square">–ö–≤–∞–¥—Ä–∞—Ç (–•—Ä—É—Å—Ç–∞–ª—å)</option>
    </select>

    <div style="margin: 10px 0;">
        <label>NEON:</label> <input type="checkbox" id="neon-on" onchange="update()" checked>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
        <input type="color" id="c-dots" value="#ffffff" oninput="update()">
        <input type="color" id="c-bg" value="#fff9e6" oninput="update()">
    </div>

    <input type="text" id="ladder-url" placeholder="URL –õ–µ—Å—Ç–Ω–∏—Ü—ã" oninput="update()">
    <input type="text" id="snake-url" placeholder="URL –ó–º–µ–∏" oninput="update()">

    <button class="btn" style="background:#9c27b0" onclick="toggleLinkMode()">–°–≤—è–∑–∞—Ç—å –∫—Ä—É–∂–∫–∏</button>
    <button class="btn" style="background:#2196F3" onclick="save()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <button class="btn" style="background:#f44336" onclick="clearFieldOnly()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    
    <textarea id="qs" placeholder="–í–æ–ø—Ä–æ—Å—ã" style="display:none"></textarea>
    <textarea id="ans" placeholder="–û—Ç–≤–µ—Ç—ã" style="display:none"></textarea>
</div>

<div id="task-modal">
    <h2 id="modal-status">–ó–ê–î–ê–ù–ò–ï!</h2>
    <div id="task-question" style="font-size:24px; margin-bottom:20px; font-weight:bold;"></div>
    <input type="text" id="answer-input">
    <button id="check-btn" onclick="checkAnswer()">CHECK</button>
</div>

<div id="victory-overlay" onclick="location.reload()"><h1>VICTORY!</h1><div style="font-size:100px">üèÜ</div></div>

<canvas id="cvs"></canvas>

<script>
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    let audioCtx = null;
    const bgMusic = new Audio(); bgMusic.loop = true;

    let state = { 
        bg: '', modalBgImg: '', music: '', tokens: ['', '', '', ''], ladderImg: '', snakeImg: '', points: [], 
        cellSize: 60, tokenW: 50, tokenH: 50, tasks: [], playerCount: 4,
        colors: { dots: '#ffffff', modalBg: '#fff9e6', modalTxt: '#333333', btnBg: '#4CAF50' }, 
        neon: true, cellShape: 'circle', font: 'Arial', diceSkin: 'classic', links: [], sheetUrl: ''
    };
    
    const bgImg = new Image();
    const ladderImgObj = new Image();
    const snakeImgObj = new Image();
    const tImgs = [new Image(), new Image(), new Image(), new Image()];
    let tPos = []; 

    function initTokens() {
        tPos = [];
        for(let i=0; i<4; i++) {
            tPos.push({x: window.innerWidth - 100, y: 50 + i*60, tx: window.innerWidth - 100, ty: 50 + i*60});
        }
    }

    let dragIdx = null, isGame = false, diceVal = "?", isRoll = false, won = false;
    let linkFrom = null, isLinkMode = false, questionQueue = [], currentQuestionIdx = 0, hue = 0, currentPlayer = 0;

    // –ì–ò–ë–ö–ò–ô –†–ê–ó–ú–ï–† –ö–ê–ù–í–ê–°–ê –î–õ–Ø GENIALLY
    function syncCanvasSize() {
        if (cvs.width !== window.innerWidth || cvs.height !== window.innerHeight) {
            cvs.width = window.innerWidth;
            cvs.height = window.innerHeight;
        }
    }

    async function loadFromSheet(url) {
        if (!url) return;
        let fetchUrl = url.replace('/edit?usp=sharing', '/export?format=csv').replace('/edit#gid=', '/export?format=csv&gid=');
        try {
            const res = await fetch(fetchUrl);
            const data = await res.text();
            const rows = data.split('\n').map(r => r.split(','));
            state.tasks = rows.filter(r => r[0]).map(r => ({ q: r[0].trim(), a: (r[1]||'').trim() }));
            prepareQuestions();
        } catch (e) { console.error(e); }
    }

    function prepareQuestions() {
        questionQueue = state.tasks.map((_, i) => i).sort(() => Math.random() - 0.5);
        currentQuestionIdx = 0;
    }

    window.onload = () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        syncCanvasSize(); initTokens();
        const p = new URLSearchParams(window.location.search);
        const d = p.get('game');
        if (d) { 
            state = JSON.parse(decodeURIComponent(escape(atob(d))));
            isGame = true; 
            document.getElementById('panel').style.display = 'none'; 
            document.getElementById('turn-indicator').style.display = 'block';
            if (state.sheetUrl) loadFromSheet(state.sheetUrl);
        }
        if(state.bg) bgImg.src = state.bg;
        if(state.ladderImg) ladderImgObj.src = state.ladderImg;
        if(state.snakeImg) snakeImgObj.src = state.snakeImg;
        update(); animate();
    };

    function animate() {
        syncCanvasSize(); // –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–∏ iFrame
        hue = (hue + 2) % 360;
        tPos.forEach(p => { 
            p.x += (p.tx - p.x) * 0.2; 
            p.y += (p.ty - p.y) * 0.2; 
        });
        draw();
        requestAnimationFrame(animate);
    }

    function roll() {
        if (isRoll || won) return;
        isRoll = true;
        let c = 0;
        const iv = setInterval(() => { 
            diceVal = Math.floor(Math.random() * 6) + 1; 
            if (++c > 12) { 
                clearInterval(iv); 
                isRoll = false; 
                if(isGame) { 
                    currentPlayer = (currentPlayer + 1) % state.playerCount; 
                    document.getElementById('turn-indicator').innerText = "–•–û–î –ò–ì–†–û–ö–ê: " + (currentPlayer + 1); 
                    showTask(); // –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û–ï –û–ö–ù–û
                } 
            } 
        }, 60);
    }

    function showTask() {
        if (!state.tasks || !state.tasks.length) return;
        if (currentQuestionIdx >= questionQueue.length) prepareQuestions();
        const t = state.tasks[questionQueue[currentQuestionIdx]];
        const m = document.getElementById('task-modal');
        m.style.backgroundColor = state.colors.modalBg;
        if(state.modalBgImg) m.style.backgroundImage = `url(${state.modalBgImg})`;
        document.getElementById('task-question').innerText = t.q;
        m.classList.add('show');
    }

    function checkAnswer() {
        const t = state.tasks[questionQueue[currentQuestionIdx]];
        const inp = document.getElementById('answer-input').value.trim().toLowerCase();
        if (inp === t.a.toLowerCase()) {
            document.getElementById('task-modal').classList.remove('show');
            document.getElementById('answer-input').value = "";
            currentQuestionIdx++;
        } else { alert("–ù–µ–≤–µ—Ä–Ω–æ!"); }
    }

    function draw() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        if (bgImg.complete && bgImg.src) ctx.drawImage(bgImg, 0, 0, cvs.width, cvs.height);

        // –û–¢–†–ò–°–û–í–ö–ê –°–í–Ø–ó–ï–ô (–õ–ï–°–¢–ù–ò–¶–´ –ò –ó–ú–ï–ò)
        state.links.forEach(link => {
            const f = state.points[link.from], t = state.points[link.to];
            if (f && t) {
                const x1 = f.x*cvs.width, y1 = f.y*cvs.height, x2 = t.x*cvs.width, y2 = t.y*cvs.height;
                const dist = Math.hypot(x2-x1, y2-y1), angle = Math.atan2(y2-y1, x2-x1);
                const isL = (y2 < y1); let img = isL ? ladderImgObj : snakeImgObj;
                if (img.complete && img.src) {
                    ctx.save(); ctx.translate(x1, y1); ctx.rotate(angle + Math.PI/2);
                    ctx.drawImage(img, -30, -dist, 60, dist); ctx.restore();
                }
            }
        });

        // –û–¢–†–ò–°–û–í–ö–ê –¢–û–ß–ï–ö
        state.points.forEach((p, i) => {
            const px = p.x * cvs.width, py = p.y * cvs.height, s = state.cellSize;
            let baseColor = state.colors.dots;
            ctx.save();
            if (state.neon) { ctx.shadowBlur = 15; ctx.shadowColor = baseColor; }
            ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
            ctx.beginPath();
            if (state.cellShape === 'circle') ctx.arc(px, py, s/2, 0, 7);
            else ctx.rect(px-s/2, py-s/2, s, s);
            ctx.fill();
            ctx.strokeStyle = baseColor; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = "white"; ctx.font = `bold ${s/3}px Arial`; ctx.textAlign = "center";
            ctx.fillText(i+1, px, py + s/10);
            ctx.restore();
        });

        // –§–ò–®–ö–ò
        tPos.forEach((p, i) => {
            if (i >= state.playerCount) return;
            ctx.save(); ctx.translate(p.x, p.y);
            ctx.fillStyle = ['#ff4d4d','#4d4dff','#4dff4d','#ffff4d'][i];
            ctx.beginPath(); ctx.arc(0,0, state.tokenW/2, 0, 7); ctx.fill();
            ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
            ctx.restore();
        });

        // –ö–£–ë–ò–ö
        ctx.fillStyle = "white"; ctx.fillRect(cvs.width-90, cvs.height-90, 70, 70);
        ctx.fillStyle = "black"; ctx.font = "bold 30px Arial"; ctx.textAlign = "center";
        ctx.fillText(diceVal, cvs.width-55, cvs.height-45);
    }

    cvs.onmousedown = (e) => {
        const rect = cvs.getBoundingClientRect();
        const x = e.clientX - rect.left, y = e.clientY - rect.top;
        if (x > cvs.width-100 && y > cvs.height-100) { roll(); return; }
        for(let i=0; i<state.playerCount; i++) {
            if (Math.hypot(x-tPos[i].x, y-tPos[i].y) < 40) { dragIdx = i; return; }
        }
        if (!isGame) {
            for (let i=0; i<state.points.length; i++) {
                if (Math.hypot(x-state.points[i].x*cvs.width, y-state.points[i].y*cvs.height) < 30) {
                    if (isLinkMode) { if (linkFrom === null) linkFrom = i; else { if(linkFrom !== i) state.links.push({from: linkFrom, to: i}); linkFrom = null; } return; }
                }
            }
            state.points.push({ x: x/cvs.width, y: y/cvs.height });
        }
    };

    cvs.onmousemove = (e) => {
        if (dragIdx === null) return;
        const rect = cvs.getBoundingClientRect();
        tPos[dragIdx].tx = e.clientX - rect.left;
        tPos[dragIdx].ty = e.clientY - rect.top;
        tPos[dragIdx].x = tPos[dragIdx].tx;
        tPos[dragIdx].y = tPos[dragIdx].ty;
    };

    cvs.onmouseup = () => { 
        if (typeof dragIdx === 'number') {
            const idx = dragIdx;
            state.points.forEach((p, pIdx) => {
                if (Math.hypot(tPos[idx].tx-p.x*cvs.width, tPos[idx].ty-p.y*cvs.height) < 50) {
                    tPos[idx].tx = p.x*cvs.width; tPos[idx].ty = p.y*cvs.height;
                    const link = state.links.find(l => l.from === pIdx);
                    if (link) {
                        setTimeout(() => {
                            tPos[idx].tx = state.points[link.to].x*cvs.width;
                            tPos[idx].ty = state.points[link.to].y*cvs.height;
                        }, 500);
                    }
                }
            });
        }
        dragIdx = null; 
    };

    function update() {
        if(isGame) return;
        state.cellSize = parseInt(document.getElementById('cell-size').value);
        state.tokenW = parseInt(document.getElementById('token-w').value);
        state.playerCount = parseInt(document.getElementById('p-count').value);
        state.colors.dots = document.getElementById('c-dots').value;
        state.colors.modalBg = document.getElementById('c-bg').value;
        state.cellShape = document.getElementById('cell-shape').value;
        state.neon = document.getElementById('neon-on').checked;
        state.sheetUrl = document.getElementById('sheet-url').value;
        state.bg = document.getElementById('bg-url').value;
        state.ladderImg = document.getElementById('ladder-url').value;
        state.snakeImg = document.getElementById('snake-url').value;
        if(state.bg) bgImg.src = state.bg;
        if(state.ladderImg) ladderImgObj.src = state.ladderImg;
        if(state.snakeImg) snakeImgObj.src = state.snakeImg;
    }

    function save() {
        update();
        const s = JSON.parse(JSON.stringify(state)); s.tasks = [];
        const url = window.location.origin + window.location.pathname + "?game=" + btoa(unescape(encodeURIComponent(JSON.stringify(s))));
        navigator.clipboard.writeText(url); alert("–°—Å—ã–ª–∫–∞ –≥–æ—Ç–æ–≤–∞!");
    }
    
    function toggleLinkMode() { isLinkMode = !isLinkMode; linkFrom = null; alert(isLinkMode ? "–†–µ–∂–∏–º —Å–≤—è–∑–∏ –í–ö–õ" : "–†–µ–∂–∏–º —Å–≤—è–∑–∏ –í–´–ö–õ"); }
    function clearFieldOnly() { state.points = []; state.links = []; }
</script>
</body>
</html>
