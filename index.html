<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Planet Game: Crystal Rainbow Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Comfortaa:wght@700&family=Bungee&family=Kelly+Slab&family=Monoton&family=Pacifico&family=Ruslan+Display&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #1a1a1a; }
        canvas { display: block; }
        #panel { position: absolute; left: 10px; top: 10px; width: 340px; 
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 10px;
            z-index: 100; color: white; border: 1px solid #444;
            max-height: 95vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #turn-indicator { position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: rgba(0,0,0,0.8); color: gold;
            border: 2px solid gold; border-radius: 20px; font-weight: bold;
            z-index: 50; display: none; font-size: 18px;
        }
        .input-wrap { position: relative; display: flex; align-items: center; margin-bottom: 8px; }
        .clear-btn { position: absolute; right: 5px; background: none; border: none; color: #888; cursor: pointer; font-size: 18px; font-weight: bold; padding: 0 5px; line-height: 1; z-index: 5; }
        .clear-btn:hover { color: #f44336; }
        .tasks-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .tasks-row div { flex: 1; }
        .tasks-row textarea { height: 80px; resize: none; }
        .colors-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .colors-grid label { font-size: 10px; display: flex; flex-direction: column; }
        input, textarea, select { width: 100%; background: #222; color: white; border: 1px solid #555; padding: 5px 25px 5px 5px; box-sizing: border-box; border-radius: 4px; }
        .neon-row { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .size-settings { margin-bottom: 15px; }
        .half-width-sliders { display: flex; gap: 10px; }
        .half-width-sliders div { flex: 1; }
        .size-label { font-size: 11px; margin-bottom: 4px; display: block; }
        #font-preview { background: #444; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 10px; font-size: 18px; border: 1px solid #666; min-height: 25px; }
        #task-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 400px; min-height: 200px; padding: 30px; border-radius: 20px; z-index: 10000; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 2px solid #f0e68c; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); background-size: cover; background-position: center; }
        #task-modal.show { transform: translate(-50%, -50%) scale(1); display: block; }
        #answer-input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 16px; border: 1px solid #ccc; background: white; color: #333; }
        #check-btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; color: white; }
        #victory-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, #ff9999, #ffcc99, #ffff99, #99ff99, #99ccff, #cc99ff); background-size: 400% 400%; animation: rainbowMove 6s ease infinite; z-index: 20000; flex-direction: column; justify-content: center; align-items: center; color: #444; text-align: center; cursor: pointer; }
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        @keyframes rainbowMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .cup { font-size: 150px; z-index: 20001; position: relative; }
    </style>
</head>
<body>

<div id="turn-indicator">–•–û–î –ò–ì–†–û–ö–ê: 1</div>

<div id="panel">
    <!-- —Ç–≤–æ–π –≤–µ—Å—å HTML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞–∫ –±—ã–ª -->
    <!-- ... –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞–Ω–µ–ª–∏ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
</div>

<div id="victory-overlay" onclick="location.reload()">
    <canvas id="confetti-canvas"></canvas>
    <h1 id="vic-title" style="font-size: 80px; margin: 0; position: relative; z-index: 20002;">VICTORY!</h1>
    <div class="cup">üèÜ</div>
</div>

<div id="task-modal">
    <h2 id="modal-status">–ó–ê–î–ê–ù–ò–ï!</h2>
    <div id="task-question" style="font-size:24px; margin-bottom:20px; font-weight:bold; word-wrap: break-word;"></div>
    <input type="text" id="answer-input">
    <button id="check-btn" onclick="checkAnswer()">CHECK</button>
</div>

<canvas id="cvs"></canvas>

<script>
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const cnfCvs = document.getElementById('confetti-canvas');
    const cnfCtx = cnfCvs.getContext('2d');
    
    let audioCtx = null;
    const bgMusic = new Audio(); bgMusic.loop = true;

    let state = { 
        bg: '', modalBgImg: '', music: '', tokens: ['', '', '', ''], ladderImg: '', snakeImg: '', points: [], 
        cellSize: 60, ladderTh: 60, snakeTh: 60, tokenW: 50, tokenH: 50, tasks: [], playerCount: 4,
        colors: { dots: '#ffffff', modalBg: '#fff9e6', modalTxt: '#333333', btnBg: '#4CAF50', trail: '#ffffff' }, 
        neon: true, randQ: true, cellShape: 'circle', font: 'Arial', diceSkin: 'classic',
        trailType: 'match', startPos: {x:400, y:150}, finishPos: {x:400, y:250}, links: [],
        sheetUrl: ''
    };
    const bgImg = new Image();
    const tImgs = [new Image(), new Image(), new Image(), new Image()];
    const ladderImgObj = new Image();
    const snakeImgObj = new Image();
    let tPos = [
        {x:window.innerWidth-150,y:50,tx:window.innerWidth-150,ty:50, angle:0, isWin:false}, 
        {x:window.innerWidth-80,y:50,tx:window.innerWidth-80,ty:50, angle:0, isWin:false}, 
        {x:window.innerWidth-150,y:120,tx:window.innerWidth-150,ty:120, angle:0, isWin:false}, 
        {x:window.innerWidth-80,y:120,tx:window.innerWidth-80,ty:120, angle:0, isWin:false}
    ];
    let dragIdx = null, isGame = false, diceVal = "?", isRoll = false, won = false;
    let linkFrom = null, isLinkMode = false, particles = [], trailParticles = [], questionQueue = [], currentQuestionIdx = 0;
    let pulseFrame = 0, hue = 0, currentPlayer = 0;

    // –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ loadFromSheet, playSfx, playDiceSound, playVictorySfx, encode, decode, prepareQuestions, applyStateToAssets
    // –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

    function animate() {
        pulseFrame += 0.035;
        hue = (hue + 2) % 360;

        tPos.forEach((p, i) => { 
            let oldX = p.x, oldY = p.y;
            p.x += (p.tx - p.x) * 0.35; 
            p.y += (p.ty - p.y) * 0.35; 
            if (p.isWin) p.angle += 0.2;
            if (state.trailType !== 'none' && Math.hypot(p.x - oldX, p.y - oldY) > 0.1) {
                let color;
                if(state.trailType === 'rainbow') color = `hsl(${hue}, 100%, 70%)`;
                else if(state.trailType === 'custom') color = state.colors.trail;
                else color = ['#ff4d4d','#4d4dff','#4dff4d','#ffff4d'][i];
                for(let k=0; k<2; k++) trailParticles.push({ 
                    x: p.x + (Math.random()-0.5)*15, 
                    y: p.y + (Math.random()-0.5)*15, 
                    vx: (Math.random()-0.5), vy: (Math.random()-0.5), 
                    life: 1.0, color: color, size: Math.random()*2+1 
                });
            }
        });

        trailParticles = trailParticles.filter(p => {
            p.x += p.vx; 
            p.y += p.vy; 
            p.life -= 0.02; 
            return p.life > 0;
        });

        draw();

        if (won) {
            cnfCtx.clearRect(0, 0, cnfCvs.width, cnfCvs.height);
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;
            });
            particles = particles.filter(p => p.y <= cnfCvs.height + 50);
            particles.forEach(p => {
                cnfCtx.fillStyle = p.color;
                cnfCtx.beginPath();
                cnfCtx.arc(p.x, p.y, p.r, 0, 7);
                cnfCtx.fill();
            });
            if (Math.random() > 0.6) for(let i=0; i<5; i++) particles.push({
                x: cnfCvs.width/2, y: cnfCvs.height/2,
                vx: (Math.random()-0.5)*20, vy: (Math.random()-0.7)*20,
                color: `hsl(${Math.random()*360},100%,50%)`,
                r: Math.random()*5+2, gravity: 0.2
            });
        }

        requestAnimationFrame(animate);
    }

    // –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ draw, roll, showTask, checkAnswer, update, cvs.onmousedown, cvs.onmousemove
    // –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

</script>

</body>
</html>
