<!-- ВАЖНО: это твой код + безопасное хранение state -->
<!-- НИЖЕ ТОЛЬКО ИЗМЕНЁННЫЕ ЧАСТИ, остальное БЕЗ ИЗМЕНЕНИЙ -->

<script>
/* === NEW: helpers === */
function generateId() {
    return 'g_' + Math.random().toString(36).substr(2, 9);
}

function saveToLocal(id, data) {
    localStorage.setItem(id, JSON.stringify(data));
}

function loadFromLocal(id) {
    const raw = localStorage.getItem(id);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
}

/* === ПЕРЕОПРЕДЕЛЯЕМ save() === */
function save() {
    const id = generateId();
    saveToLocal(id, state);
    const url = window.location.origin + window.location.pathname + "?gameId=" + id;
    navigator.clipboard.writeText(url);
    alert("Короткая ссылка сохранена!\nМожно вставлять в Genially.");
}

/* === ПЕРЕОПРЕДЕЛЯЕМ getIframe() === */
function getIframe() {
    const id = generateId();
    saveToLocal(id, state);
    const url = window.location.origin + window.location.pathname + "?gameId=" + id;
    const code = `<iframe src="${url}" width="100%" height="600" style="border:none;" allow="autoplay; fullscreen"></iframe>`;
    navigator.clipboard.writeText(code);
    alert("iFrame скопирован! Ссылка короткая и безопасная.");
}

/* === МЕНЯЕМ init() === */
function init() {
    window.addEventListener('resize', resize);
    resize();

    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('gameId');

    if (gameId) {
        const loaded = loadFromLocal(gameId);
        if (loaded) {
            state = loaded;
            isGame = true;
            document.getElementById('panel').style.display = 'none';
            document.getElementById('turn-indicator').style.display = 'block';
        }
    }

    document.body.style.fontFamily = state.font;
    document.getElementById('vic-title').style.fontFamily = state.font;

    if (state.music) {
        bgMusic.src = state.music;
    }

    applyStateToAssets();
    prepareQuestions();
    update();
    animate();
}
</script>
